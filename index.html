<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ Glow Up Academy</title>
    <style>
        :root { --pink: #FF6B9D; --purple: #A29BFE; --bg: #FFF5F8; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 10px; }
        .screen { width: 100%; max-width: 450px; display: none; }
        .active { display: block !important; }
        .card { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        h1 { color: var(--pink); margin-bottom: 20px; }
        input { width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #eee; border-radius: 15px; box-sizing: border-box; font-size: 1rem; }
        .btn { background: var(--pink); color: white; border: none; padding: 15px; width: 100%; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }
        .stats-bar { display: flex; justify-content: space-between; background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; font-weight: bold; }
        .ex-list { display: grid; gap: 10px; }
        .ex-item { background: white; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; cursor: pointer; border-left: 5px solid var(--purple); }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab { padding: 8px 12px; background: #eee; border-radius: 10px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; }
        .tab.active { background: var(--pink); color: white; }
        .error { color: #ff4757; font-size: 0.8rem; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen active">
        <div class="card">
            <h1 id="auth-title">Connexion</h1>
            <input type="text" id="username" placeholder="Ton Identifiant (ex: Julie75)">
            <input type="password" id="pass" placeholder="Mot de passe">
            <button onclick="validerAuth()" class="btn" id="btn-text">Se connecter ðŸš€</button>
            <p onclick="toggleMode()" style="color:var(--pink); cursor:pointer; margin-top:15px;" id="switch-link">CrÃ©er un compte</p>
            <div id="auth-error" class="error"></div>
        </div>
    </div>

    <div id="dashboard" class="screen">
        <div class="stats-bar">
            <span id="display-user">Joueur</span>
            <span style="color: #00CEC9;">ðŸ’Ž <span id="diamond-val">0</span></span>
            <button onclick="location.reload()" style="border:none; background:none; cursor:pointer;">ðŸšª</button>
        </div>

        <div id="view-list">
            <div class="tab-menu">
                <div class="tab active" onclick="filtrer('math')">ðŸ”¢ Maths</div>
                <div class="tab" onclick="filtrer('french')">ðŸ“š FranÃ§ais</div>
                <div class="tab" onclick="filtrer('english')">ðŸ‡¬ðŸ‡§ Anglais</div>
            </div>
            <div id="ex-container" class="ex-list"></div>
        </div>

        <div id="view-play" style="display:none;" class="card">
            <h2 id="ex-cat">Mission</h2>
            <p id="ex-q" style="font-size:1.2rem; margin:20px 0;"></p>
            <input type="text" id="ex-ans" placeholder="RÃ©ponse...">
            <button onclick="checkAns()" class="btn">Valider âœ…</button>
            <button onclick="showList()" class="btn" style="background:#ccc">Retour</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const S_URL = 'https://lcbwehiwjowgthazrydy.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjYndlaGl3am93Z3RoYXpyeWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTg4NjIsImV4cCI6MjA4NDkzNDg2Mn0.2nP42Uh262Jt-1stolzSVM8_EEzrAdCutKgd7B2MurY';
        const client = window.supabase.createClient(S_URL, S_KEY, { auth: { persistSession: false } });

        let session = null;
        let diamonds = 0;
        let mode = 'login';
        let currentEx = null;

        // --- GÃ‰NÃ‰RATION DES 60 EXERCICES (20 PAR MATIÃˆRE) ---
        const EXERCICES = [];
        for(let i=1; i<=20; i++) {
            EXERCICES.push({ id: i, cat: 'math', q: `${i*5} + ${i*2} = ?`, a: (i*5+i*2).toString(), r: 10 });
            EXERCICES.push({ id: i+20, cat: 'french', q: `Pluriel de 'Mot ${i}' ?`, a: `mots ${i}`, r: 10 });
            EXERCICES.push({ id: i+40, cat: 'english', q: `Translate 'Number ${i}'`, a: `nombre ${i}`, r: 10 });
        }

        function toggleMode() {
            mode = (mode === 'login') ? 'signup' : 'login';
            document.getElementById('auth-title').innerText = (mode === 'login') ? "Connexion" : "Inscription";
            document.getElementById('btn-text').innerText = (mode === 'login') ? "Se connecter ðŸš€" : "CrÃ©er mon compte âœ¨";
        }

        async function validerAuth() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('pass').value;
            // On transforme l'identifiant en email interne
            const fakeEmail = user + "@glowup.com";

            try {
                if(mode === 'signup') {
                    const { data, error } = await client.auth.signUp({ email: fakeEmail, password: pass });
                    if(error) throw error;
                    await client.from('profiles').insert([{ id: data.user.id, email: user, diamonds: 0 }]);
                    alert("Compte crÃ©Ã© avec l'identifiant : " + user);
                    location.reload();
                } else {
                    const { data, error } = await client.auth.signInWithPassword({ email: fakeEmail, password: pass });
                    if(error) throw error;
                    session = data.user;
                    chargerProfil();
                }
            } catch (e) { document.getElementById('auth-error').innerText = e.message; }
        }

        async function chargerProfil() {
            const { data } = await client.from('profiles').select('*').eq('id', session.id).single();
            if(data) {
                diamonds = data.diamonds;
                document.getElementById('diamond-val').innerText = diamonds;
                document.getElementById('display-user').innerText = data.email;
            }
            document.getElementById('auth-screen').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            filtrer('math');
        }

        function filtrer(cat) {
            const cont = document.getElementById('ex-container');
            cont.innerHTML = "";
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText.toLowerCase().includes(cat)));
            EXERCICES.filter(e => e.cat === cat).forEach(ex => {
                const d = document.createElement('div');
                d.className = "ex-item";
                d.innerHTML = `<span>Exercice #${ex.id}</span> <b>+${ex.r} ðŸ’Ž</b>`;
                d.onclick = () => { currentEx = ex; showPlay(); };
                cont.appendChild(d);
            });
        }

        function showPlay() {
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-play').style.display = 'block';
            document.getElementById('ex-q').innerText = currentEx.q;
        }

        function showList() {
            document.getElementById('view-list').style.display = 'block';
            document.getElementById('view-play').style.display = 'none';
        }

        async function checkAns() {
            if(document.getElementById('ex-ans').value.trim().toLowerCase() === currentEx.a.toLowerCase()) {
                alert("Bravo ! + " + currentEx.r + " ðŸ’Ž");
                diamonds += currentEx.r;
                document.getElementById('diamond-val').innerText = diamonds;
                await client.from('profiles').update({ diamonds: diamonds }).eq('id', session.id);
                showList();
            } else { alert("Faux, essaie encore !"); }
        }
    </script>
</body>
</html>
