// ========== Configuration Supabase ==========
const SUPABASE_URL = 'https://lcbwehiwjowgthazrydy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjYndlaGl3am93Z3RoYXpyeWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTg4NjIsImV4cCI6MjA4NDkzNDg2Mn0.2nP42Uh262Jt-1stolzSVM8_EEzrAdCutKgd7B2MurY';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== √âtat Global ==========
let currentUser = null;
let currentProfile = null;
let isSignUp = false;
let currentExercise = null;

// ========== Banque d'Exercices ==========
const exerciseBank = {
    french: [
        { question: "Quelle est la bonne orthographe ?", options: ["Papillon", "Papion", "Papilion", "Papyion"], correct: 0 },
        { question: "Trouve le verbe conjugu√© correctement :", options: ["Je mange", "Je manger", "Je manges", "Je mangez"], correct: 0 },
        { question: "Quel mot est bien √©crit ?", options: ["√âl√©phant", "√âlefant", "√âlephant", "Elefan"], correct: 0 },
        { question: "Compl√®te : Il ___ √† l'√©cole", options: ["va", "vas", "vat", "vais"], correct: 0 },
        { question: "Pluriel de 'journal' ?", options: ["journaux", "journals", "journales", "journeaux"], correct: 0 }
    ],
    math: [
        { question: "7 + 5 = ?", type: "input", correct: "12" },
        { question: "15 - 8 = ?", type: "input", correct: "7" },
        { question: "6 √ó 3 = ?", type: "input", correct: "18" },
        { question: "20 √∑ 4 = ?", type: "input", correct: "5" },
        { question: "9 + 9 = ?", type: "input", correct: "18" }
    ],
    logic: [
        { question: "Si tous les chats ont 4 pattes et Minou est un chat, combien de pattes a Minou ?", options: ["2", "4", "6", "8"], correct: 1 },
        { question: "Quelle forme vient ensuite ? ‚≠êüåô‚≠êüåô‚≠ê", options: ["‚≠ê", "üåô", "‚òÄÔ∏è", "üåü"], correct: 1 },
        { question: "Dans une course, tu d√©passes le 2√®me. En quelle position es-tu ?", options: ["1er", "2√®me", "3√®me", "Dernier"], correct: 1 },
        { question: "Quel nombre vient ensuite ? 2, 4, 6, 8...", options: ["9", "10", "11", "12"], correct: 1 }
    ]
};

// ========== Avatars Boutique ==========
const shopAvatars = [
    { id: 'default', name: 'Avatar Classique', price: 0, seed: 'default' },
    { id: 'robot', name: 'Robot Spatial', price: 50, seed: 'robot123' },
    { id: 'unicorn', name: 'Licorne Magique', price: 100, seed: 'unicorn456' },
    { id: 'ninja', name: 'Ninja Furtif', price: 150, seed: 'ninja789' },
    { id: 'dragon', name: 'Dragon de Feu', price: 200, seed: 'dragon321' },
    { id: 'wizard', name: 'Sorcier Mystique', price: 250, seed: 'wizard654' }
];

// ========== Initialisation ==========
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Glow Up Academy - D√©marrage');
    checkSession();
    setupAuthListeners();
    setupNavigation();
    setupSettings();
    loadTheme();
    loadDysMode();
});

// ========== Authentification ==========
async function checkSession() {
    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            console.log('‚úÖ Session:', session.user.email);
            currentUser = session.user;
            await loadProfile();
            showDashboard();
        } else {
            showAuth();
        }
    } catch (error) {
        console.error('‚ùå Erreur session:', error);
        showAuth();
    }
}

function setupAuthListeners() {
    document.getElementById('auth-submit').addEventListener('click', handleAuth);
    document.getElementById('auth-switch').addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthMode();
    });
    document.querySelectorAll('#auth-email, #auth-password').forEach(input => {
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAuth(); });
    });
}

function toggleAuthMode() {
    isSignUp = !isSignUp;
    document.getElementById('auth-title').textContent = isSignUp ? 'Cr√©er un compte' : 'Connexion';
    document.getElementById('auth-submit').textContent = isSignUp ? "S'inscrire ‚ú®" : 'Se connecter üöÄ';
    document.getElementById('auth-switch-text').textContent = isSignUp ? 'D√©j√† un compte ?' : 'Pas encore de compte ?';
    document.getElementById('auth-switch').textContent = isSignUp ? 'Se connecter' : 'Cr√©er un compte';
    document.getElementById('auth-error').textContent = '';
}

async function handleAuth() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const errorEl = document.getElementById('auth-error');
    const submitBtn = document.getElementById('auth-submit');
    
    if (!email || !password) {
        errorEl.style.color = '#FF6B6B';
        errorEl.textContent = '‚ö†Ô∏è Remplis tous les champs !';
        return;
    }
    if (password.length < 6) {
        errorEl.style.color = '#FF6B6B';
        errorEl.textContent = '‚ö†Ô∏è Mot de passe : 6 caract√®res minimum';
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Chargement...';
    errorEl.textContent = '';
    
    try {
        if (isSignUp) {
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            if (data.user) {
                currentUser = data.user;
                await new Promise(r => setTimeout(r, 1000));
                if (await createProfile(data.user.id, email)) {
                    await loadProfile();
                    errorEl.style.color = '#4ECDC4';
                    errorEl.textContent = '‚úÖ Compte cr√©√© ! üéâ';
                    setTimeout(() => showDashboard(), 1000);
                }
            }
        } else {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            currentUser = data.user;
            await loadProfile();
            errorEl.style.color = '#4ECDC4';
            errorEl.textContent = '‚úÖ Connexion r√©ussie ! üéâ';
            setTimeout(() => showDashboard(), 800);
        }
    } catch (error) {
        errorEl.style.color = '#FF6B6B';
        if (error.message.includes('Invalid login')) errorEl.textContent = '‚ùå Email ou mot de passe incorrect';
        else if (error.message.includes('already registered')) errorEl.textContent = '‚ùå Email d√©j√† utilis√©';
        else errorEl.textContent = `‚ùå ${error.message}`;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = isSignUp ? "S'inscrire ‚ú®" : 'Se connecter üöÄ';
    }
}

async function createProfile(userId, email) {
    try {
        const { data, error } = await supabase.from('profiles').insert({
            id: userId, email, diamonds: 100, level: 1, theme: 'pink',
            avatar_url: 'https://api.dicebear.com/7.x/bottts/svg?seed=default',
            quests_completed: 0, owned_avatars: JSON.stringify(['default'])
        }).select().single();
        if (error) return false;
        currentProfile = data;
        return true;
    } catch (error) {
        console.error('‚ùå Cr√©ation profil:', error);
        return false;
    }
}

async function loadProfile() {
    try {
        const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
        if (error && error.code === 'PGRST116') {
            if (await createProfile(currentUser.id, currentUser.email)) return await loadProfile();
            return;
        }
        if (error) return;
        currentProfile = data;
        updateUI();
        loadShop();
    } catch (error) {
        console.error('‚ùå Chargement profil:', error);
    }
}

async function updateProfile(updates) {
    try {
        const { data, error } = await supabase.from('profiles').update(updates).eq('id', currentUser.id).select().single();
        if (error) return false;
        currentProfile = data;
        updateUI();
        return true;
    } catch (error) {
        return false;
    }
}

function updateUI() {
    if (!currentProfile) return;
    const username = currentProfile.email?.split('@')[0] || 'Joueur';
    document.getElementById('player-name').textContent = username;
    document.getElementById('player-level').textContent = currentProfile.level || 1;
    document.getElementById('player-diamonds').textContent = currentProfile.diamonds || 0;
    document.getElementById('player-avatar').src = currentProfile.avatar_url;
    document.getElementById('profile-username').textContent = username;
    document.getElementById('profile-level').textContent = currentProfile.level || 1;
    document.getElementById('profile-diamonds').textContent = currentProfile.diamonds || 0;
    document.getElementById('profile-avatar').src = currentProfile.avatar_url;
    document.getElementById('quests-completed').textContent = currentProfile.quests_completed || 0;
    document.getElementById('profile-theme').textContent = currentProfile.theme === 'pink' ? 'Rose üíñ' : 'Bleu üíô';
    if (currentProfile.theme) {
        document.body.setAttribute('data-theme', currentProfile.theme);
        document.querySelectorAll('.theme-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.theme === currentProfile.theme);
        });
    }
}

async function logout() {
    await supabase.auth.signOut();
    currentUser = null;
    currentProfile = null;
    showAuth();
}

function showAuth() {
    document.getElementById('auth-screen').classList.add('active');
    document.getElementById('dashboard-screen').classList.remove('active');
}

function showDashboard() {
    document.getElementById('auth-screen').classList.remove('active');
    document.getElementById('dashboard-screen').classList.add('active');
}

// ========== Navigation ==========
function setupNavigation() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => navigateTo(btn.dataset.page));
    });
    document.getElementById('logout-btn').addEventListener('click', logout);
}

function navigateTo(pageName) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.page === pageName));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`${pageName}-page`)?.classList.add('active');
}

// ========== Exercices ==========
function startQuest(type) {
    const exercises = exerciseBank[type];
    currentExercise = { type, data: exercises[Math.floor(Math.random() * exercises.length)] };
    showExercise();
}

function showExercise() {
    const modal = document.getElementById('exercise-modal');
    const title = document.getElementById('exercise-title');
    const content = document.getElementById('exercise-content');
    const buttons = document.getElementById('exercise-buttons');
    
    const types = { french: ['üìö', 'Fran√ßais'], math: ['üî¢', 'Math√©matiques'], logic: ['üß©', 'Logique'] };
    title.textContent = `${types[currentExercise.type][0]} ${types[currentExercise.type][1]}`;
    
    if (currentExercise.data.type === 'input') {
        content.innerHTML = `<div class="exercise-question">${currentExercise.data.question}</div>
            <input type="number" id="exercise-answer" class="exercise-input" placeholder="Ta r√©ponse...">`;
        buttons.innerHTML = `<button class="btn btn-primary" onclick="checkInputAnswer()">Valider ‚úì</button>`;
        setTimeout(() => {
            const inp = document.getElementById('exercise-answer');
            inp.focus();
            inp.addEventListener('keypress', e => { if (e.key === 'Enter') checkInputAnswer(); });
        }, 100);
    } else {
        content.innerHTML = `<div class="exercise-question">${currentExercise.data.question}</div>
            <div class="exercise-options">${currentExercise.data.options.map((o, i) => 
                `<button class="option-btn" onclick="checkAnswer(${i})">${o}</button>`).join('')}</div>`;
        buttons.innerHTML = '';
    }
    modal.classList.add('active');
}

function checkAnswer(idx) {
    const feedback = document.getElementById('exercise-feedback');
    const btns = document.querySelectorAll('.option-btn');
    btns.forEach(b => b.disabled = true);
    
    if (idx === currentExercise.data.correct) {
        btns[idx].classList.add('correct');
        feedback.textContent = 'üéâ Excellent ! +10 diamants ! üíé';
        feedback.className = 'feedback success';
        updateProfile({
            diamonds: currentProfile.diamonds + 10,
            quests_completed: (currentProfile.quests_completed || 0) + 1,
            level: Math.floor(((currentProfile.quests_completed || 0) + 1) / 5) + 1
        });
        setTimeout(closeExercise, 2500);
    } else {
        btns[idx].classList.add('incorrect');
        btns[currentExercise.data.correct].classList.add('correct');
        feedback.textContent = '‚ùå Rat√© ! R√©essaye ! üí™';
        feedback.className = 'feedback error';
        setTimeout(closeExercise, 3500);
    }
}

function checkInputAnswer() {
    const input = document.getElementById('exercise-answer');
    const answer = input.value.trim();
    const feedback = document.getElementById('exercise-feedback');
    
    if (!answer) {
        feedback.textContent = '‚ö†Ô∏è Entre une r√©ponse !';
        feedback.className = 'feedback error';
        return;
    }
    
    if (answer === currentExercise.data.correct) {
        feedback.textContent = 'üéâ Parfait ! +10 diamants ! üíé';
        feedback.className = 'feedback success';
        input.disabled = true;
        updateProfile({
            diamonds: currentProfile.diamonds + 10,
            quests_completed: (currentProfile.quests_completed || 0) + 1,
            level: Math.floor(((currentProfile.quests_completed || 0) + 1) / 5) + 1
        });
        setTimeout(closeExercise, 2500);
    } else {
        feedback.textContent = `‚ùå Non, c'√©tait ${currentExercise.data.correct} !`;
        feedback.className = 'feedback error';
        input.disabled = true;
        setTimeout(closeExercise, 3500);
    }
}

function closeExercise() {
    document.getElementById('exercise-modal')?.classList.remove('active');
    currentExercise = null;
}

// ========== Boutique ==========
function loadShop() {
    const grid = document.getElementById('shop-items');
    if (!grid || !currentProfile) return;
    
    let owned = ['default'];
    try { owned = JSON.parse(currentProfile.owned_avatars); } catch (e) {}
    
    grid.innerHTML = shopAvatars.map(a => {
        const isOwned = owned.includes(a.id);
        const url = `https://api.dicebear.com/7.x/bottts/svg?seed=${a.seed}`;
        const canBuy = currentProfile.diamonds >= a.price;
        return `<div class="shop-item ${isOwned ? 'owned' : ''}">
            <img src="${url}" alt="${a.name}">
            <h4>${a.name}</h4>
            <p class="shop-price">üíé ${a.price}</p>
            ${isOwned ? `<button class="btn btn-primary" onclick="equipAvatar('${a.id}','${url}')">√âquiper</button>` :
            `<button class="btn btn-shop" onclick="buyAvatar('${a.id}',${a.price},'${url}')" ${!canBuy ? 'disabled' : ''}>
                ${canBuy ? 'Acheter' : 'Pas assez de üíé'}</button>`}
        </div>`;
    }).join('');
}

async function buyAvatar(id, price, url) {
    if (currentProfile.diamonds < price) {
        alert('‚ùå Pas assez de diamants !');
        return;
    }
    let owned = ['default'];
    try { owned = JSON.parse(currentProfile.owned_avatars); } catch (e) {}
    if (!owned.includes(id)) owned.push(id);
    
    if (await updateProfile({ diamonds: currentProfile.diamonds - price, owned_avatars: JSON.stringify(owned), avatar_url: url })) {
        alert('üéâ Avatar achet√© ! ‚ú®');
        loadShop();
    }
}

async function equipAvatar(id, url) {
    if (await updateProfile({ avatar_url: url })) {
        alert('‚úÖ Avatar √©quip√© ! ‚ú®');
        loadShop();
    }
}

// ========== Param√®tres ==========
function setupSettings() {
    document.getElementById('settings-btn')?.addEventListener('click', () => {
        document.getElementById('settings-modal')?.classList.add('active');
    });
}

function closeSettings() {
    document.getElementById('settings-modal')?.classList.remove('active');
}

async function changeTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === theme));
    if (currentProfile) await updateProfile({ theme });
}

function toggleDysMode() {
    const enabled = document.getElementById('dys-mode-toggle')?.checked;
    document.body.classList.toggle('dys-mode', enabled);
    localStorage.setItem('dys-mode', enabled);
}

function loadTheme() {
    document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'pink');
}

function loadDysMode() {
    const enabled = localStorage.getItem('dys-mode') === 'true';
    document.body.classList.toggle('dys-mode', enabled);
    const toggle = document.getElementById('dys-mode-toggle');
    if (toggle) toggle.checked = enabled;
}

window.addEventListener('click', e => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); });
