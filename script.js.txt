// TES INFOS SUPABASE
const SUPABASE_URL = "https://lcbwehiwjowgthazrydy.supabase.co";
const SUPABASE_KEY = "sb_publishable_xgO0Nt7F-URpWSwS0zC8Zg_c8s9uA8Q";
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let state = { pts: 0, diamonds: 50, avatar: 'ðŸ‘¸', userId: null };
let currentQ = 0, score = 0, currentTheme = '';

// --- AUTHENTIFICATION ---
async function handleSignUp() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await _supabase.auth.signUp({ email, password });
    if (error) alert("Erreur : " + error.message);
    else alert("Super ! VÃ©rifie tes emails pour confirmer et te connecter. âœ¨");
}

async function handleLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
    if (error) alert("Mince : " + error.message);
    else {
        state.userId = data.user.id;
        await syncData(); // On rÃ©cupÃ¨re les diamants sauvÃ©s
        document.getElementById('auth-screen').style.display = 'none';
        confetti({ particleCount: 150, spread: 70 });
    }
}

// --- BASE DE DONNÃ‰ES ---
async function syncData() {
    // On essaie de rÃ©cupÃ©rer le profil
    let { data, error } = await _supabase.from('profiles').select('*').eq('id', state.userId).single();
    
    if (error && error.code === 'PGRST116') {
        // Si le profil n'existe pas, on le crÃ©e
        const { data: newProfile } = await _supabase.from('profiles').insert([
            { id: state.userId, diamonds: 50, points: 0, avatar: 'ðŸ‘¸' }
        ]).select().single();
        data = newProfile;
    }

    if (data) {
        state.diamonds = data.diamonds;
        state.pts = data.points;
        state.avatar = data.avatar;
        updateUI();
    }
}

async function saveProgress() {
    if (!state.userId) return;
    await _supabase.from('profiles').update({ 
        diamonds: state.diamonds, 
        points: state.pts 
    }).eq('id', state.userId);
}

// --- LOGIQUE DU JEU ---
const quizzes = {
    'saca': [{ q: "Elle a pris ___ sac.", a: "sa" }, { q: "___ va bien.", a: "Ã§a" }],
    'est': [{ q: "___ super !", a: "C'est" }, { q: "Il ___ lavÃ©.", a: "s'est" }],
    'er': [{ q: "Aller mang___.", a: "er" }, { q: "J'ai mang___.", a: "Ã©" }]
};

function startQuiz(theme) {
    currentTheme = theme; currentQ = 0; score = 0;
    showScreen('quiz');
    nextQuestion();
}

function nextQuestion() {
    const qData = quizzes[currentTheme][currentQ];
    document.getElementById('q-text').innerText = qData.q.replace('___', '______');
    document.getElementById('progress').style.width = (currentQ * (100/quizzes[currentTheme].length)) + '%';
    const options = document.getElementById('options');
    options.innerHTML = '';
    
    let choices = currentTheme === 'saca' ? ['sa', 'Ã§a'] : (currentTheme === 'est' ? ["C'est", "S'est"] : ["Ã©", "er"]);

    choices.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'option-btn'; btn.innerText = c;
        btn.onclick = () => {
            if(c.toLowerCase() === qData.a.toLowerCase()) { score += 2; confetti({particleCount: 20}); }
            currentQ++;
            if(currentQ < quizzes[currentTheme].length) nextQuestion();
            else finishQuiz();
        };
        options.appendChild(btn);
    });
}

function finishQuiz() {
    let gain = score * 5;
    state.diamonds += gain;
    state.pts += (score * 2);
    document.getElementById('res-score').innerText = score + "/20";
    document.getElementById('res-gain').innerText = "+" + gain + " Diamants ðŸ’Ž";
    showScreen('result');
    updateUI();
    saveProgress(); // SAUVEGARDE DANS SUPABASE
}

function updateUI() {
    document.getElementById('user-diamonds').innerText = state.diamonds;
    document.getElementById('user-points').innerText = state.pts;
    document.getElementById('main-avatar').innerText = state.avatar;
    document.getElementById('user-level').innerText = Math.floor(state.pts / 100) + 1;
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function logout() {
    _supabase.auth.signOut();
    location.reload();
}